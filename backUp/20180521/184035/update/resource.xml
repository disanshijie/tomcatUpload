<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.eyou.trader.resource.domain.Resource" >

   <sql id="Base_Column_List" >
    code,title,travel_date travelDate,start_city startCity,end_city endCity,board_city_id boardCityId,word_content,
    board_city boardCity,way_city_ids wayCityIds,way_city wayCity,days,um_price umPrice,trader_price traderPrice,
    price,cruise_company_id cruiseCompanyId,cruise_company cruiseCompany,cruise_id cruiseId,product_type productType,
    team_type teamType,provider_code providerCode,provider_name,create_time createTime,bus_price,insurance_price,
    show_level showLevel, publisher_name publisherName,pic_path picPath, status,word_path wordPath,is_hot isHot,is_up isUp,num,version_flag resVersionFlag
  </sql>
  <!--查询自驾和精品游信息  -->
  <select id="searchDriverTravelRes" parameterType="com.eyou.trader.resource.domain.Resource" resultType="com.eyou.trader.resource.domain.Resource" >
  	select num,IF( (#{traderLevel} = 0 OR #{traderLevel}=1), um_price , trader_price) price
  		from tb_resource
  	where code=#{code}
  </select>
  <!--改变热门状态  -->
  <update id="turnIntoIsHot" parameterType="com.eyou.trader.resource.domain.Resource" >
  		update tb_resource
  		<set>
  			is_hot=#{isHot},
  			is_up=#{isUp}
  		</set>
  		where
  			code=#{code}
  </update>
  <!--改变置顶状态  -->
  <update id="turnIntoIsUp" parameterType="com.eyou.trader.resource.domain.Resource" >
  		update tb_resource
  			set is_up=#{isUp}
  		where
  			code=#{code}
  </update>
  <!--更新资源信息  -->
  <update id="updateResourceInfo">
  	update tb_resource
  	<set>
  		version_flag = #{versionFlag} + 1, 
  		<if test="title!=null">title=#{title},</if>
  		<if test="picPath!=null">pic_path=#{picPath},</if>
  		<if test="travelDate!=null">travel_date=#{travelDate},</if>
  		<if test="boardCityId!=null">board_City_Id=#{boardCityId},</if>
  		<if test="boardCity!=null">board_city=#{boardCity},</if>
  		<if test="startCity!=null">start_city=#{startCity},</if>
  		<if test="endCity!=null">end_city=#{endCity},</if>
  		<if test="wayCity!=null">way_City=#{wayCity},</if>
  		<if test="days!=null">days=#{days},</if>
  		<if test="traderPrice!=null">trader_Price=#{traderPrice},</if>
  		<if test="price!=null">price=#{price},</if>
  		<if test="busPrice!=null">bus_price=#{busPrice},</if>
  		<if test="insurancePrice!=null">insurance_price=#{insurancePrice},</if>
  		<if test="addSpacePrice!=null">addSpace_price=#{addSpacePrice},</if>
  		<if test="cruiseCompanyId!=null">cruise_company_id=#{cruiseCompanyId},</if>
  		<if test="cruiseCompany!=null">cruise_company=#{cruiseCompany},</if>
		<if test="shippingLineId!=null">shipping_line_id=#{shippingLineId},</if>
		<if test="shippingLine!=null">shipping_line=#{shippingLine},</if>
  		<if test="cruiseId!=null">cruise_id=#{cruiseId},</if>
  		<if test="cruiseName!=null">cruise_name=#{cruiseName},</if>
  		<if test="providerCode!=null">provider_code=#{providerCode},</if>
  		<if test="providerName!=null">provider_name=#{providerName},</if>
  		<if test="showLevel!=null">show_level=#{showLevel},</if>
  		<if test="wordContent!=null">word_content=#{wordContent},</if>
  		<if test="wordPath!=null">word_path=#{wordPath},</if>
  		<if test="productType!=null">product_type=#{productType},</if>
  		<if test="num!=null">num=#{num},</if>
  		<if test="status!=null">status=#{status},</if>
  		<if test="isHot!=null">is_hot=#{isHot},</if>
  		<if test="priceContain!=null">price_contain=#{priceContain},</if>
  		<if test="reservation!=null">reservation=#{reservation},</if>
  		<if test="startCity!=null">start_city=#{startCity},</if>
  		um_price=#{umPrice}
  	</set>
  		where code=#{code} and version_flag = #{versionFlag}
  </update>

	<!--更新航次  -->
	<update id="updateProductVersion" parameterType="com.eyou.trader.resource.domain.ProductVersion">
		update tb_resource_version
		<set>
			<if test="title!=null">title=#{title},</if>
			<if test="startDate!=null">startDate=#{startDate},</if>
			<if test="endDate!=null">endDate=#{endDate},</if>
			<if test="description!=null">description=#{description},</if>
			<if test="wayCity!=null">way_city=#{wayCity},</if>
			<if test="crusieLimit!=null">crusie_limit=#{crusieLimit},</if>
			<if test="status!=null">status=#{status},</if>
			<if test="primaryHot!=null">primaryHot=#{primaryHot},</if>
			<if test="monthHot!=null">monthHot=#{monthHot},</if>
			<if test="generalHot!=null">generalHot=#{generalHot},</if>
			<if test="primaryUp!=null">primaryUp=#{primaryUp},</if>
			<if test="monthUp!=null">monthUp=#{monthUp},</if>
			<if test="generalUp!=null">generalUp=#{generalUp},</if>
			<if test="totalNum!=null">total_num=#{totalNum},</if>
			<if test="num!=null">num=#{num},</if>
			<if test="umPrice!=null">um_price=#{umPrice},</if>
			<if test="traderPrice!=null">trader_price=#{traderPrice},</if>
			<if test="crusieLimit!=null">crusie_limit=#{crusieLimit},</if>
			<if test="price!=null">price=#{price},</if>
		</set>
		where id=#{id}
	</update>
	<!--取消设置推荐更新航次顺序  -->
	<update id="updateProductVersionUp" parameterType="com.eyou.trader.resource.domain.ProductVersion">
		update tb_resource_version
		<set>
			<if test="primaryHot!=null">primaryHot=#{primaryHot},</if>
			<if test="monthHot!=null">monthHot=#{monthHot},</if>
			<if test="generalHot!=null">generalHot=#{generalHot},</if>
			primaryUp=#{primaryUp},
			monthUp=#{monthUp},
			generalUp=#{generalUp}
		</set>
		where id=#{id}
	</update>

  <!--查找产品信息  -->
  <select id="searchProductByResourceInfo" parameterType="com.eyou.trader.resource.domain.Resource" resultType="com.eyou.trader.resource.domain.Resource">
  select 
  	code,title,pic_path picPath, travel_date travelDate,start_city startCity,end_city endCity,board_city_id boardCityId,
    board_city boardCity,way_city_ids wayCityIds,way_city wayCity,days,um_price umPrice,trader_price traderPrice,
    price,cruise_company_id cruiseCompanyId,cruise_company cruiseCompany,cruise_id cruiseId,cruise_name cruiseName,product_type productType,num, reservation, price_contain priceContain,
    show_level showLevel,status,word_content wordContent,is_hot isHot, version_flag versionFlag,bus_price busPrice,
    insurance_price insurancePrice,addSpace_price addSpacePrice,shipping_line_id shippingLineId,shipping_line shippingLine
  from tb_resource
  where code=#{code}
  </select>
  <!--批量更新资源状态  -->
  <update id="passBatchCheckByResourceInfo" parameterType="list">
  	<foreach collection="list" item="item" index="index" separator=";">
  	update tb_resource 
  		<set>
  		status=#{item.status}
  		</set> 
  	where 
  		code=#{item.code}
  	</foreach>
  </update>
  <!--保存船舱数量  -->
	<update id="saveResourceNum" parameterType="resource">
	 update tb_resource
	 	set
	 		num=#{num},
	 		total_num=#{num}
	 	where
	 		code=#{code}
	</update>
  <!--批量更新船舱剩余间数 -->
    <update id="updateCruiseHouseNum" parameterType="java.util.List">
  	<foreach collection="list" item="item" index="index" separator=";">
  		update tb_cruise_house 
  		<set>
  			house_num=house_num-#{item.houseNum},person_num =person_num-#{item.personNum}, version_flag = version_flag +1
  		</set>
  		where
  			id = #{item.id}
  			and house_num <![CDATA[>=]]> #{item.houseNum}
		    and person_num <![CDATA[>=]]> #{item.personNum}
    			and version_flag = #{item.versionFlag}
  	</foreach>
  </update>
  <!--批量更新船舱剩余人数 -->
    <update id="updateCruisePersonNum" parameterType="java.util.List">
  	<foreach collection="list" item="item" index="index" separator=";">
  		update tb_cruise_house 
  		<set>
	  		person_num=person_num-#{item.personNum}
	  		</set> 
  		where 
  		id=#{item.id}
  	</foreach>
  </update>
  <!--更新船舱信息-->
  <update id="updateCruiseHouse" parameterType="list">
	  	update 
	  		tb_cruise_house
	  	set
	  		house_num = #{houseNum},person_num=#{personNum}, version_flag = version_flag+1
	  	where 
	  		id=#{id}
	  		and house_num <![CDATA[>=]]> 0
		    and person_num <![CDATA[>=]]> 0
<!-- 	  		and version_flag = #{versionFlag} -->
  </update>
  <!--更新船舱信息-->
  <update id="updateCruiseHouseNumSingle" parameterType="com.eyou.trader.resource.domain.CruiseHouse">
	  	update 
	  		tb_cruise_house
	  	set
	  		house_num=house_num-#{houseNum},person_num =person_num-#{personNum}, version_flag = version_flag +1
	  	where 
  			id = #{id}
  			and house_num <![CDATA[>=]]> #{houseNum}
		    and person_num <![CDATA[>=]]> #{personNum}
  </update>

	<!--编辑船舱信息-->
	<update id="editCruiseHouse" parameterType="com.eyou.trader.resource.domain.CruiseHouse">
		update
		tb_cruise_house
		<set>
			<if test="totalNum!=null">total_num=#{totalNum},</if>
			<if test="cruiseTotalNum!=null">cruise_total_num=#{cruiseTotalNum},</if>
			<if test="houseNum!=null">house_num=#{houseNum},</if>
			<if test="totalPerson!=null">total_person=#{totalPerson},</if>
			<if test="personNum!=null">person_num=#{personNum},</if>
			<if test="umPrice!=null">um_price=#{umPrice},</if>
			<if test="traderPrice!=null">trader_price=#{traderPrice},</if>
			<if test="customerPrice!=null">customer_price=#{customerPrice},</if>
		</set>
		where id=#{id}

	</update>
	<!--保存舱型信息  -->
	<insert id="saveCruiseHouse" parameterType="com.eyou.trader.resource.domain.CruiseHouse">
		insert into
		tb_cruise_house
		<trim prefix="(" suffix=")" suffixOverrides="," >
			<if test="id!=null">id,</if>
			<if test="resourceCode!=null">resource_code,</if>
			<if test="vid!=null">vid,</if>
			<if test="cruiseId!=null">cruise_id,</if>
			<if test="cabinId!=null">cabin_id,</if>
			<if test="cabinName!=null">cabin_name,</if>
			<if test="shippingSpaceId!=null">shipping_space_id,</if>
			<if test="houseType!=null">house_type,</if>
			<if test="housePersonNum!=null">house_person_num,</if>
			<if test="totalNum!=null">total_num,</if>
			<if test="cruiseTotalNum!=null">cruise_total_num,</if>
			<if test="houseNum!=null">house_num,</if>
			<if test="totalPerson!=null">total_person,</if>
			<if test="personNum!=null">person_num,</if>
			<if test="umPrice!=null">um_price,</if>
			<if test="traderPrice!=null">trader_price,</if>
			<if test="customerPrice!=null">customer_price,</if>
			<if test="orderNum!=null">order_num,</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			<if test="id!=null">#{id},</if>
			<if test="resourceCode!=null">#{resourceCode},</if>
			<if test="vid!=null">#{vid},</if>
			<if test="cruiseId!=null">#{cruiseId},</if>
			<if test="cabinId!=null">#{cabinId},</if>
			<if test="cabinName!=null">#{cabinName},</if>
			<if test="shippingSpaceId!=null">#{shippingSpaceId},</if>
			<if test="houseType!=null">#{houseType},</if>
			<if test="housePersonNum!=null">#{housePersonNum},</if>
			<if test="totalNum!=null">#{totalNum},</if>
			<if test="cruiseTotalNum!=null">#{cruiseTotalNum},</if>
			<if test="houseNum!=null">#{houseNum},</if>
			<if test="totalPerson!=null">#{totalPerson},</if>
			<if test="personNum!=null">#{personNum},</if>
			<if test="umPrice!=null">#{umPrice},</if>
			<if test="traderPrice!=null">#{traderPrice},</if>
			<if test="customerPrice!=null">#{customerPrice},</if>
			<if test="orderNum!=null">#{orderNum},</if>
		</trim>
	</insert>
  <!--批量插入船舱信息  -->
  <insert id="publishHouse" parameterType="list">
  	  insert into tb_cruise_house
	    <trim prefix="(" suffix=")" suffixOverrides="," >
	       id,
		   cruise_id,
		   cabin_id,
		   cabin_name,
		   shipping_space_id,
	       resource_code,
		   vid,
	       house_type,
	       house_person_num,
	       cruise_total_num,
	       total_num,
	       house_num,
		   total_person,
		   person_num,
	       um_price,
	       trader_price,
	       customer_price,
	       order_num,
	       version_flag,
	    </trim>
	  	  values
    <foreach collection="list" item="item" index="index" separator="," >
       <trim prefix="(" suffix=")" suffixOverrides="," >
		    #{item.id},
            #{item.cruiseId},
            #{item.cabinId},
            #{item.cabinName},
            #{item.shippingSpaceId},
            #{item.resourceCode},
            #{item.vid},
            #{item.houseType},
            #{item.housePersonNum},
            #{item.cruiseTotalNum},
            #{item.totalNum},
            #{item.houseNum},
            #{item.totalPerson},
            #{item.personNum},
            #{item.umPrice},
            #{item.traderPrice},
            #{item.customerPrice},
            #{item.orderNum},
            0
       </trim>
    </foreach>
  </insert>
   <!--批量插入船舱行程描述信息  -->
  <insert id="pubDescribe" parameterType="java.util.List">
  	  insert into tb_resource_schedule
	    <trim prefix="(" suffix=")" suffixOverrides="," >
	       id,
	       resource_code,
	       vid,
	       days_order,
	       title,
	       outline,
	       flight,
	       breakfast,
	       lunch,
	       dinner,
	       hotel,
	       create_time,
	       type,
	       pic1
	    </trim>
	  	  values
    <foreach collection="list" item="item" index="index" separator="," >
       <trim prefix="(" suffix=")" suffixOverrides="," >       
            #{item.id},
            #{item.resourceCode},
            #{item.vid},
            #{item.daysOrder},
            #{item.title},
            #{item.outline},
            #{item.flight},
            #{item.breakfast},
            #{item.lunch},
            #{item.dinner},
            #{item.hotel},
            #{item.createTime},
            #{item.type},
            #{item.pic1}
       </trim>
    </foreach>
  </insert>
  <!--更新资源状态  -->
  <update id="updateResourceStatus" parameterType="resource" >
  	update tb_resource 
  		set status=#{status}
  		where code=#{code}
  </update>
  <!--查询word文档内容  -->
  <select id="searchWordContentByResourceInfo" resultType="java.lang.String" parameterType="resource">
  	select word_content
  		from tb_resource
  	where code=#{code}
  </select>
  <!--查询出发城市  -->
  <select id="searchStartCity" resultType="java.util.Map" >
  	select
		id,name,pid
	from
		tb_cruise_destination
	order by
		id
  </select>
  <!--插入资源信息  -->
  <insert id="saveResourceInfo" parameterType="com.eyou.trader.resource.domain.Resource">
  insert into 
  			tb_resource
  		 <trim prefix="(" suffix=")" suffixOverrides="," >
  		<if test="code!=null">code,</if>
  		<if test="title!=null">title,</if>
  		<if test="travelDate!=null">travel_date,</if>
  		<if test="boardCityId!=null">board_city_id,</if>
  		<if test="boardCity!=null">board_city,</if>
  		<if test="startCity!=null">start_city,</if>
  		<if test="endCity!=null">end_city,</if>
  		<if test="wayCity!=null">way_city,</if>
  		<if test="days!=null">days,</if>
  		<if test="traderPrice!=null">trader_price,</if>
  		<if test="price!=null">price,</if>
  		<if test="busPrice!=null">bus_price,</if>
  		<if test="insurancePrice!=null">insurance_price,</if>
  		<if test="addSpacePrice!=null">addSpace_price,</if>
  		<if test="cruiseCompanyId!=null">cruise_company_id,</if>
  		<if test="cruiseCompany!=null">cruise_company,</if>
		<if test="shippingLineId!=null">shipping_line_id,</if>
		<if test="shippingLine!=null">shipping_line,</if>
  		<if test="cruiseId!=null">cruise_id,</if>
  		<if test="cruiseId!=null">cruise_name,</if>
  		<if test="providerCode!=null">provider_Code,</if>
  		<if test="providerName!=null">provider_Name,</if>
  		<if test="showLevel!=null">show_level,</if>
  		<if test="wordContent!=null">word_content,</if>
  		<if test="wordPath!=null">word_path,</if>
  		<if test="picPath!=null">pic_path,</if>
  		<if test="productType!=null">product_Type,</if>
  		<if test="num!=null">num,</if>
  		publisher_id, publisher_name, reservation,price_contain,
  		<if test="status!=null">status,</if>
  		<if test="isHot!=null">is_hot,</if>
  		<if test="umPrice!=null">um_price,</if>
  		</trim>
  	<trim prefix="values (" suffix=")" suffixOverrides="," >
  		<if test="code!=null">#{code},</if>
  		<if test="title!=null">#{title},</if>
  		<if test="travelDate!=null">#{travelDate},</if>
  		<if test="boardCityId!=null">#{boardCityId},</if>
  		<if test="boardCity!=null">#{boardCity},</if>
  		<if test="startCity!=null">#{startCity},</if>
  		<if test="endCity!=null">#{endCity},</if>
  		<if test="wayCity!=null">#{wayCity},</if>
  		<if test="days!=null">#{days},</if>
  		<if test="traderPrice!=null">#{traderPrice},</if>
  		<if test="price!=null">#{price},</if>
		<if test="busPrice!=null">#{busPrice},</if>
		<if test="insurancePrice!=null">#{insurancePrice},</if>
		<if test="addSpacePrice!=null">#{addSpacePrice},</if>
  		<if test="cruiseCompanyId!=null">#{cruiseCompanyId},</if>
  		<if test="cruiseCompany!=null">#{cruiseCompany},</if>
		<if test="shippingLineId!=null">#{shippingLineId},</if>
		<if test="shippingLine!=null">#{shippingLine},</if>
  		<if test="cruiseId!=null">#{cruiseId},</if>
  		<if test="cruiseName!=null">#{cruiseName},</if>
  		<if test="providerCode!=null">#{providerCode},</if>
  		<if test="providerName!=null">#{providerName},</if>
  		<if test="showLevel!=null">#{showLevel},</if>
  		<if test="wordContent!=null">#{wordContent},</if>
  		<if test="wordPath!=null">#{wordPath},</if>
  		<if test="picPath!=null">#{picPath},</if>
  		<if test="productType!=null">#{productType},</if>
  		<if test="num!=null">#{num},</if>
  		#{publisherId}, #{publisherName}, #{reservation}, #{priceContain},
  		<if test="status!=null">#{status},</if>
  		<if test="isHot!=null">#{isHot},</if>
  		<if test="umPrice!=null">#{umPrice},</if>
  	</trim>
  </insert>

	<!--插入航次信息  -->
	<insert id="saveProductVersion" parameterType="com.eyou.trader.resource.domain.ProductVersion">
		insert into
		tb_resource_version
		<trim prefix="(" suffix=")" suffixOverrides="," >
			<if test="id!=null">id,</if>
			<if test="resCode!=null">resCode,</if>
			<if test="title!=null">title,</if>
			<if test="startDate!=null">startDate,</if>
			<if test="wayCity!=null">way_city,</if>
			<if test="endDate!=null">endDate,</if>
			<if test="description!=null">description,</if>
			<if test="createTime!=null">create_time,</if>
			<if test="totalNum!=null">total_num,</if>
			<if test="num!=null">num,</if>
			<if test="umPrice!=null">um_price,</if>
			<if test="traderPrice!=null">trader_price,</if>
			<if test="price!=null">price,</if>
			<if test="crusieLimit!=null">crusie_limit,</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			<if test="id!=null">#{id},</if>
			<if test="resCode!=null">#{resCode},</if>
			<if test="title!=null">#{title},</if>
			<if test="startDate!=null">#{startDate},</if>
			<if test="wayCity!=null">#{wayCity},</if>
			<if test="endDate!=null">#{endDate},</if>
			<if test="description!=null">#{description},</if>
			<if test="createTime!=null">#{createTime},</if>
			<if test="totalNum!=null">#{totalNum},</if>
			<if test="num!=null">#{num},</if>
			<if test="umPrice!=null">#{umPrice},</if>
			<if test="traderPrice!=null">#{traderPrice},</if>
			<if test="price!=null">#{price},</if>
			<if test="crusieLimit!=null">#{crusieLimit},</if>
		</trim>
	</insert>

  <!--查找资源表到产品页面  -->
  <select id="searchResourceListToProduce" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.Resource">
  select  <include refid="Base_Column_List" />
  from tb_resource
  where 1=1
  	      <if test="productType != 0 and productType != null ">
	      	and product_type = #{productType}
	      </if>
	      <if test="providerName != '' and providerName != null ">
	      	and	provider_name like concat('%', #{providerName}, '%')
	      </if>
	      <if test="providerCode != '' and providerCode != null ">
	      	and	provider_code = #{providerCode}
	      </if>
	      <if test="status != 4 and status != null ">
	      	and status = #{status}
	      </if>
	      <if test="code != '' and code != null ">
	      	and code = #{code}
	      </if>
	      <if test="title != '' and title != null ">
	      	and title like concat('%', #{title}, '%')
	      </if>
	      <if test="travelDate != '' and travelDate != null ">
	      	and travel_date <![CDATA[>=]]> #{travelDate}
	      </if>
	      <if test="deadline != '' and deadline != null ">
	      	and  travel_date <![CDATA[<=]]> #{deadline}
	      </if>
	      <if test="days != '' and days != null ">
	      and days = #{days}
	      </if>
		  <if test="isHot != '' and isHot != null ">
			  and is_hot = #{isHot}
		  </if>
		  <if test="isUp != '' and isUp != null ">
			  and is_up = #{isUp}
		  </if>
		  <if test="showLevel != '' and showLevel != null ">
			  and show_level = #{showLevel}
		  </if>
		  <if test="cruiseCompanyId != '' and cruiseCompanyId != null ">
			and cruise_company_id = #{cruiseCompanyId}
		  </if>
		  <if test="cruiseId != '' and cruiseId != null ">
			  and cruise_id = #{cruiseId}
		  </if>
	    order by is_up, travel_date
  </select>
  <select id="searchResourceVersionList" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.ProductVersion">
	   SELECT  rv.id,rv.way_city, rv.resCode code, rv.title, rv.startDate, rv.endDate, rv.status, rv.primaryUp, rv.monthUp, rv.generalUp,
	   rv.primaryHot, rv.monthHot, rv.generalHot, r.product_type productType, r.provider_name providerName,
	   r.days, r.publisher_name publisherName, r.start_city startCity
	   FROM tb_resource_version rv
	   LEFT JOIN tb_resource r
	   ON rv.resCode = r.code
	   WHERE 1=1
          <if test="productType != 0 and productType != null ">
            and r.product_type = #{productType}
        </if>
        <if test="status != 3 and status != null ">
            and rv.status = #{status}
        </if>
        <if test="providerName != '' and providerName != null ">
            and	r.provider_name like concat('%', #{providerName}, '%')
        </if>
        <if test="providerCode != '' and providerCode != null ">
            and	r.provider_code = #{providerCode}
        </if>
        <if test="startDate != '' and startDate != null ">
            and DATE_FORMAT(rv.startDate, '%Y-%m-%d') like concat('%', #{startDate}, '%')
        </if>
        <if test="primaryHot != 3 and primaryHot != null ">
            and rv.primaryHot = #{primaryHot}
        </if>
        <if test="monthHot != 3 and monthHot != null ">
            and rv.monthHot = #{monthHot}
        </if>
        <if test="generalHot != 3 and generalHot != null ">
            and rv.generalHot = #{generalHot}
        </if>
        <if test="primaryUp != 3 and primaryUp != null ">
            and rv.primaryUp = #{primaryUp}
        </if>
        <if test="monthUp != 3 and monthUp != null ">
            and rv.monthUp = #{monthUp}
        </if>
        <if test="generalUp != 3 and generalUp != null ">
            and rv.generalUp = #{generalUp}
        </if>
        <if test="resCode != '' and resCode != null ">
            and rv.resCode = #{resCode}
        </if>
        <if test="id != '' and id != null ">
            and rv.id = #{id}
        </if>
        <if test="title != '' and title != null ">
            and rv.title like concat('%', #{title}, '%')
        </if>
        <if test="startDate != '' and startDate != null ">
            and rv.startDate <![CDATA[>=]]> #{startDate}
        </if>
        <if test="endDate != '' and endDate != null ">
            and rv.endDate <![CDATA[<=]]> #{endDate}
        </if>
      <if test="primaryHot == 1 ">
            order by rv.primaryUp
        </if>
      <if test="monthHot == 1 ">
            order by rv.monthUp
        </if>
      <if test="generalHot == 1 ">
            order by rv.generalUp
       </if>
  </select>
  <!--查找资源表到产品页面  -->
  <select id="searchTraderResourceVersionListToProduce" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.ProductVersion">
	  SELECT
	  b.id, b.code,b.title,b.startDate startDate,b.endDate,b.status,b.productType ,b.providerCode ,b.providerName , b.traderPrice,   b.price , b.umPrice ,b.insurance_price,b.bus_price,b.cruiseCompanyId,b.cruiseCompany,b.shippingLineId,b.shippingLine,
	  b.days days,  b.publisherName  ,b.startCity ,b.endCity, b.primaryHot,  b.monthHot,  b.generalHot  ,b.primaryUp  ,b.monthUp  ,b.generalUp , b.picPath ,b.cruiseId,MIN(a.trader_price) minPrice
	  FROM (SELECT
	  rv.id,
	  rv.resCode CODE,
	  rv.title,
	  rv.way_city wayCity,
	  rv.startDate,
	  rv.endDate,
	  rv.status,
	  rv.primaryHot,
	  rv.monthHot,
	  rv.generalHot,
	  rv.primaryUp,
	  rv.monthUp,
	  rv.generalUp,
	  r.cruise_company_id cruiseCompanyId,
	  r.cruise_company cruiseCompany,
	  r.shipping_line_id shippingLineId,
	  r.shipping_line shippingLine,
	  r.product_type productType,
	  r.provider_code providerCode,
	  r.provider_name providerName,
	  r.trader_price traderPrice,
	  r.price price,
	  r.um_price umPrice,
	  r.bus_price,
	  r.insurance_price,
	  r.days,
	  r.publisher_name publisherName,
	  r.start_city startCity,
	  r.end_city endCity,
	  r.pic_path picPath,
	  r.cruise_id cruiseId
	  FROM
	  tb_resource_version rv
	  LEFT JOIN tb_resource r
	  ON rv.resCode = r.code
	  WHERE 1 = 1
	  <if test="productType != 0 and productType != null ">
		  and r.product_type = #{productType}
	  </if>
	  <if test="status != 3 and status != null ">
		  and rv.status = #{status}
	  </if>
	  <if test="providerName != '' and providerName != null ">
		  and	r.provider_name like concat('%', #{providerName}, '%')
	  </if>
	  <if test="providerCode != '' and providerCode != null ">
		  and	r.provider_code != #{providerCode}
	  </if>
	  <if test="startCity != 0 and startCity != null ">
		  and r.board_city_id like CONCAT(#{startCity}, '%')
	  </if>
	  <if test="cruiseCompany != 0 and cruiseCompany != null ">
		  and r.cruise_company = #{cruiseCompany}
	  </if>
	  <if test="cruiseCompanyId != 0 and cruiseCompanyId != null ">
		  and r.cruise_company_id = #{cruiseCompanyId}
	  </if>
	  <if test="cruiseId != 0 and cruiseId != null ">
		  and r.cruise_id = #{cruiseId}
	  </if>
	  <if test="shippingLine != 0 and shippingLine != null ">
		  and r.shipping_line_id = #{shippingLine}
	  </if>
	  <if test="startDate != '' and startDate != null ">
		  and DATE_FORMAT(rv.startDate, '%Y-%m-%d') like concat('%', #{startDate}, '%')
	  </if>
	  <if test="primaryHot != 3 and primaryHot != null ">
		  and rv.primaryHot = #{primaryHot}
	  </if>
	  <if test="monthHot != 3 and monthHot != null ">
		  and rv.monthHot = #{monthHot}
	  </if>
	  <if test="generalHot != 3 and generalHot != null ">
		  and rv.generalHot = #{generalHot}
	  </if>
	  <if test="primaryUp != 3 and primaryUp != null ">
		  and rv.primaryUp = #{primaryUp}
	  </if>
	  <if test="monthUp != 3 and monthUp != null ">
		  and rv.monthUp = #{monthUp}
	  </if>
	  <if test="generalUp != 3 and generalUp != null ">
		  and rv.generalUp = #{generalUp}
	  </if>
	  <if test="resCode != '' and resCode != null ">
		  and rv.resCode = #{resCode}
	  </if>
	  <if test="id != '' and id != null ">
		  and rv.id = #{id}
	  </if>
	  <if test="title != '' and title != null ">
		  and rv.title like concat('%', #{title}, '%')
	  </if>
      ) b LEFT JOIN tb_cruise_house a ON b.id = a.vid
      WHERE 1=1
       <choose>
	      <when test="cabinId == 0 ">
	      	and a.cabin_id = #{cabinId}
	      </when>
	      <when  test="cabinId == 1">
	      	and a.cabin_id <![CDATA[<>]]> 0
	      </when>
        </choose>
	  GROUP BY a.vid
	  HAVING  1=1
  		
	  <if test="startDay != null and startDay != ''">
		  and b.days
		  <![CDATA[>=]]>#{startDay}
	  </if>
	  <if test="endDay != null and endDay != ''">
		  and b.days
		  <![CDATA[<=]]>#{endDay}
	  </if>

	  <if test="minPrice != null and minPrice != ''">
		  and minPrice
		  <![CDATA[>=]]>#{minPrice}
	  </if>
	  <if test="maxPrice != null and maxPrice != ''">
		  and minPrice
		  <![CDATA[<=]]>#{maxPrice}
	  </if>

  </select>
  <!--查找资源表到产品页面  -->
  <select id="searchCustomerResourceVersionListToProduce" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.ProductVersion">
	  SELECT
	  b.id, b.code,b.title,b.startDate startDate,b.endDate,b.status,b.productType ,b.providerCode ,b.providerName , b.traderPrice,   b.price , b.umPrice ,b.insurance_price,b.bus_price,b.cruiseCompanyId,b.cruiseCompany,b.shippingLineId,b.shippingLine,
	  b.days days,  b.publisherName  ,b.startCity ,b.endCity, b.primaryHot,  b.monthHot,  b.generalHot  ,b.primaryUp  ,b.monthUp  ,b.generalUp , b.picPath ,b.cruiseId,MIN(a.customer_price) minPrice
	  FROM (SELECT
	  rv.id,
	  rv.resCode CODE,
	  rv.title,
	  rv.way_city wayCity,
	  rv.startDate,
	  rv.endDate,
	  rv.status,
	  rv.primaryHot,
	  rv.monthHot,
	  rv.generalHot,
	  rv.primaryUp,
	  rv.monthUp,
	  rv.generalUp,
	  r.cruise_company_id cruiseCompanyId,
	  r.cruise_company cruiseCompany,
	  r.shipping_line_id shippingLineId,
	  r.shipping_line shippingLine,
	  r.product_type productType,
	  r.provider_code providerCode,
	  r.provider_name providerName,
	  r.trader_price traderPrice,
	  r.price price,
	  r.um_price umPrice,
	  r.bus_price,
	  r.insurance_price,
	  r.days,
	  r.publisher_name publisherName,
	  r.start_city startCity,
	  r.end_city endCity,
	  r.pic_path picPath,
	  r.cruise_id cruiseId
	  FROM
	  tb_resource_version rv
	  LEFT JOIN tb_resource r
	  ON rv.resCode = r.code
	  WHERE 1 = 1
	  <if test="productType != 0 and productType != null ">
		  and r.product_type = #{productType}
	  </if>
	  <if test="status != 3 and status != null ">
		  and rv.status = #{status}
	  </if>
	  <if test="providerName != '' and providerName != null ">
		  and	r.provider_name like concat('%', #{providerName}, '%')
	  </if>
	  <if test="providerCode != '' and providerCode != null ">
		  and	r.provider_code != #{providerCode}
	  </if>
	  <if test="startCity != 0 and startCity != null ">
		  and r.board_city_id like CONCAT(#{startCity}, '%')
	  </if>
	  <if test="cruiseCompany != 0 and cruiseCompany != null ">
		  and r.cruise_company = #{cruiseCompany}
	  </if>
	  <if test="cruiseCompanyId != 0 and cruiseCompanyId != null ">
		  and r.cruise_company_id = #{cruiseCompanyId}
	  </if>
	  <if test="cruiseId != 0 and cruiseId != null ">
		  and r.cruise_id = #{cruiseId}
	  </if>
	  <if test="shippingLine != 0 and shippingLine != null ">
		  and r.shipping_line_id = #{shippingLine}
	  </if>
	  <if test="startDate != '' and startDate != null ">
		  and DATE_FORMAT(rv.startDate, '%Y-%m-%d') like concat('%', #{startDate}, '%')
	  </if>
	  <if test="primaryHot != 3 and primaryHot != null ">
		  and rv.primaryHot = #{primaryHot}
	  </if>
	  <if test="monthHot != 3 and monthHot != null ">
		  and rv.monthHot = #{monthHot}
	  </if>
	  <if test="generalHot != 3 and generalHot != null ">
		  and rv.generalHot = #{generalHot}
	  </if>
	  <if test="primaryUp != 3 and primaryUp != null ">
		  and rv.primaryUp = #{primaryUp}
	  </if>
	  <if test="monthUp != 3 and monthUp != null ">
		  and rv.monthUp = #{monthUp}
	  </if>
	  <if test="generalUp != 3 and generalUp != null ">
		  and rv.generalUp = #{generalUp}
	  </if>
	  <if test="resCode != '' and resCode != null ">
		  and rv.resCode = #{resCode}
	  </if>
	  <if test="id != '' and id != null ">
		  and rv.id = #{id}
	  </if>
	  <if test="title != '' and title != null ">
		  and rv.title like concat('%', #{title}, '%')
	  </if>
      ) b LEFT JOIN tb_cruise_house a ON b.id = a.vid
      WHERE 1=1
       <choose>
	      <when test="cabinId == 0 ">
	      	and a.cabin_id = #{cabinId}
	      </when>
	      <when  test="cabinId == 1">
	      	and a.cabin_id <![CDATA[<>]]> 0
	      </when>
        </choose>
	  GROUP BY a.vid
	  HAVING  1=1
  		
	  <if test="startDay != null and startDay != ''">
		  and b.days
		  <![CDATA[>=]]>#{startDay}
	  </if>
	  <if test="endDay != null and endDay != ''">
		  and b.days
		  <![CDATA[<=]]>#{endDay}
	  </if>

	  <if test="minPrice != null and minPrice != ''">
		  and minPrice
		  <![CDATA[>=]]>#{minPrice}
	  </if>
	  <if test="maxPrice != null and maxPrice != ''">
		  and minPrice
		  <![CDATA[<=]]>#{maxPrice}
	  </if>

  </select>
 <!--查找资源表到产品页面  -->
  <select id="searchResourceVersionListByFilter" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.ProductVersion">
  select o.* from(
  SELECT  rv.id,rv.resCode code,rv.title,rv.status,rv.primaryUp,rv.monthUp,rv.generalUp,
  rv.primaryHot,rv.monthHot,rv.generalHot,r.product_type productType,r.provider_name providerName,
  r.trader_price traderPrice,r.price price,r.days,r.um_price umPrice,r.publisher_name publisherName,
  r.start_city startCity,r.pic_path picPath,r.cruise_id cruiseId,MIN(ch.customer_price) minPrice
  FROM tb_resource_version rv
  LEFT JOIN tb_resource r
  ON rv.resCode = r.code
  LEFT JOIN tb_cruise_house ch
  ON rv.id = ch.vid
  <where> 
	   <if test="status != 3 and status != null ">
	      	and rv.status = #{status}
	    </if>
	    <if test="startDate != '' and startDate != null ">
	      	and DATE_FORMAT(rv.startDate, '%Y-%m-%d') like concat('%', #{startDate}, '%')
	    </if>
        <if test="cruiseCompanyId != '' and cruiseCompanyId != null ">
	      	and r.cruise_company_id = #{cruiseCompanyId}
	    </if>
        <if test="boardCityId != '' and boardCityId != null ">
	      	and r.board_city_id = #{boardCityId}
	    </if>
	</where>
	GROUP BY rv.id  
	)o
	<where>
		<if test="minPrice != null and minPrice != ''">
		  	and o.minPrice <![CDATA[>]]> #{minPrice}
	    </if>
	    <if test="maxPrice != null and maxPrice != ''">
	  		and o.minPrice <![CDATA[<=]]> #{maxPrice}
	    </if>
	</where>    	
     <if test='description == "1"'>    
      order by o.minPrice asc
     </if>   
     <if test='description == "2"'>    
     order by o.minPrice desc
     </if>
     <if test='description == "3"'>    
     order by o.days asc
     </if>        
     <if test='description == "4"'>  
     order by o.days desc 
     </if>    
  </select>
	<!--查找产品房型最低价  -->
	<select id="selectMinPriceByResourceCode" resultType="java.lang.Double" parameterType="com.eyou.trader.resource.domain.Resource">
		SELECT MIN(customer_price)
		FROM tb_cruise_house
		WHERE resource_code = #{code}
	</select>


	<!--查找资源表到产品页面  -->
	<select id="searchVoyageList" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.Resource">
		select rv.id, rv.resCode, rv.startDate, rv.endDate, rv.title versionTitle,rv.description,rv.total_num,rv.num,
		rv.um_price,rv.trader_price,rv.price, rv.description,rv.startDate,rv.crusie_limit,
		rv.status, rv.create_time createTime,
		r.publisher_name publisherName,r.provider_name providerName,r.product_type productType,r.days,r.cruise_id,r.cruise_name,
		r.title title
		from tb_resource_version rv
		LEFT JOIN tb_resource r ON rv.resCode = r.code
		where 1=1
		<if test="vid != '' and vid != null ">
			and rv.id = #{vid}
		</if>
		<if test="code != '' and code != null ">
			and rv.resCode = #{code}
		</if>
		<if test="productStatus != 4 and productStatus != null">
			and rv.status = #{productStatus}
		</if>
		<if test="title != '' and title !=  null">
			and	rv.title like concat('%', #{title}, '%')
		</if>
		 <if test="travelDate != '' and travelDate != null ">
	      	and rv.startDate>= #{travelDate}
	      </if>
	      <if test="deadline != '' and deadline != null ">
	      	and  rv.startDate &lt;= #{deadline}
	      </if>
		<if test="status != '' and status !=  null">
			and r.status = #{status}
		</if>
		<if test="productType != 0 and productType != null ">
	      	and r.product_type = #{productType}
	     </if>
		<if test="providerName != '' and providerName != null ">
	      	and r.provider_name like concat('%', #{providerName}, '%')
	     </if>
	    
		order by startDate DESC
	</select>
  <!-- 查询航班号 -->
  <select id="searchFlightNum" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.Cruise">
  	SELECT
		c.id,c.name,c.cruise_company_id,c.cruise_company,c.guests,c.weight,c.floor,c.first_flight
	FROM
		tb_cruise c
	where 1=1
		  <if test="id != '' and id != null ">
			and c.id = #{id}
		  </if>
		  <if test="cruiseCompanyId != '' and cruiseCompanyId != null ">
			and c.cruise_company_id = #{cruiseCompanyId}
		  </if>
  </select>
  <select id="searchDetail" resultType="java.util.Map">
  	SELECT
		r.code, r.title, r.travel_date, r.start_city, r.end_city, r.board_city,r.addSpace_price addSpacePrice,
		r.days, r.um_price, r.trader_price, r.price, r.cruise_company, r.product_type,r.provider_code,
		r.provider_name, r.num, r.word_path, r.pic_path, r.word_content, r.reservation, r.price_contain, version_flag versionFlag,
		r.bus_price,r.insurance_price,c.first_flight, c.floor, c.weight, c.guests,c.name,r.addSpace_price,r.insurance_price
	FROM
		tb_resource r
	LEFT JOIN
	    tb_cruise c
	ON  r.cruise_id = c.id
    WHERE
        c.id = #{cruiseId}
    AND
		r.code = #{code}
  </select>
  <select id="searchResourceDetail" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.Resource">
  	SELECT
  	r.code, r.title, r.travel_date, r.start_city, r.end_city, r.board_city,
  	r.days, r.um_price, r.trader_price, r.price, r.cruise_company, r.product_type,r.provider_code,
  	r.provider_name, r.num, r.word_path, r.pic_path, r.word_content, r.reservation, r.price_contain, version_flag versionFlag,
  	r.bus_price,r.insurance_price
  	FROM
  	tb_resource r
  	WHERE
  	r.code = #{code}
  </select>
  <select id="searchSchedule" parameterType="com.eyou.trader.resource.domain.ScheDescribe" resultType="java.util.Map">
		SELECT
		r.resource_code,r.vid,r.type, r.days_order, r.title, r.outline, r.flight, r.breakfast, r.lunch, r.dinner,
		r.hotel, r.pic1, r.pic2, r.pic3, r.create_time
		FROM
		tb_resource_schedule r
		where
		1=1
		<if test="resourceCode != '' and resourceCode != null ">
	      	and r.resource_code = #{resourceCode}
	    </if>
		<if test="vid != null and vid !='' ">
	      	and r.vid = #{vid}
	    </if>
	    <if test="type != null and type !='' ">
	  	  and r.type = #{type}
	    </if>
		order BY
		r.days_order
  </select>
  <select id="searchDetailWS" resultType="com.eyou.trader.resource.domain.Resource">
  	SELECT
		r.code, r.title, r.travel_date travelDate, r.start_city startCity, r.board_city boardCity,
		r.days, r.trader_price traderPrice, r.price, r.cruise_company cruiseCompany, r.product_type productType,
		r.provider_name providerName, r.num
	FROM
		tb_resource r
	where
		r.code = #{code}
  </select>
  <!--查找产品  -->
  <select id="searchResourceList" resultType="java.util.Map" parameterType="resource">
	SELECT
		r.code, r.title, r.pic_path, r.travel_date, r.product_type, r.start_city,r.end_city, r.board_city,r.board_city_id, r.provider_code,
		r.days,r.um_price, r.trader_price traderPrice, r.price, r.cruise_company,r.cruise_id,
		r.provider_name, r.num, r.word_path, r.version_flag resVersionFlag,r.bus_price,r.insurance_price
	FROM
	tb_resource r
	<where> 
<!-- 	 		1=1 and r.num <![CDATA[>]]> 0 -->
	      <if test="status != '' and status != null ">
	      	and r.status = #{status}
	      </if>
	      <if test="productType != '' and productType != null ">
	      	and r.product_type = #{productType}
	      </if>
      	  <if test="providerCode != null and providerCode != '' ">
			 and r.provider_code != #{providerCode}
	      </if>
	      <if test="boardCity != 0 and boardCity != null ">
	      	and r.board_city_id like CONCAT(#{boardCity}, '%')
	      </if>
	      <if test="wayCity !='' and wayCity != null ">
	      	and r.way_city like CONCAT('%', #{wayCity}, '%')
	      </if>
	      <if test="cruiseCompany != 0 and cruiseCompany != null ">
			and r.cruise_company_id = #{cruiseCompany}
		  </if>
		  <if test="endCity != '' and endCity != null ">
		    and r.end_city = #{endCity}
		  </if>
	      <if test="startTime != '' and startTime != null ">
	      	and DATE_FORMAT(r.travel_date, '%Y-%m-%d') <![CDATA[>=]]> #{startTime}
	      </if>
	      <if test="endTime != '' and endTime != null ">
	      	and DATE_FORMAT(r.travel_date, '%Y-%m-%d') <![CDATA[<=]]> #{endTime}
	      </if>
	      <if test="travelDate != '' and travelDate != null ">
	      	and DATE_FORMAT(r.travel_date, '%Y-%m-%d') like concat('%', #{travelDate}, '%')
	      </if>
	      <if test="title != '' and title != null ">
	      	and	r.title like concat('%', #{title}, '%')
	      </if>
	      <if test="providerName != '' and providerName != null ">
	      	and	r.provider_name like concat('%', #{providerName}, '%')
	      </if>
		  <if test="startDay != null and startDay != ''">
			  and r.days <![CDATA[>=]]> #{startDay}
		  </if>
		  <if test="endDay != null and endDay != ''">
			  and r.days <![CDATA[<=]]> #{endDay}
		  </if>
			<!--<if test="days != null and days !='' and days !=0 ">
				<choose>
	      		<when test="days == 1">
					and r.days <![CDATA[<=]]> 5
	      		</when>
	      		<when test="days == 2">
					and r.days <![CDATA[>=]]> 6 and r.days <![CDATA[<=]]> 11
	      		</when>
	      		<when test="days == 3">
					and r.days <![CDATA[>=]]> 12 and r.days <![CDATA[<=]]> 15
	      		</when>
	      		<when test="days == 4">
					and r.days <![CDATA[>=]]> 16 and r.days <![CDATA[<=]]> 20
	      		</when>
	      		<when test="days == 5">
					and r.days <![CDATA[>=]]> 21 and r.days <![CDATA[<=]]> 30
	      		</when>
	      		<when test="days == 6">
			      	and r.days <![CDATA[>]]> 30
	      		</when>
	      	</choose>
			</if>-->
			<!--<choose>
				<when test="price != null and price == 1">
					and r.price <![CDATA[<=]]> 3000
				</when>
				<when test="price != null and price == 2">
					and r.price <![CDATA[>=]]> 3000 and r.price <![CDATA[<=]]> 5000
				</when>
				<when test="price != null and price == 3">
					and r.price <![CDATA[>=]]> 5000 and r.price <![CDATA[<=]]> 10000
				</when>
				<when test="price != null and price == 4">
					and r.price <![CDATA[>=]]> 10000 and r.price <![CDATA[<=]]> 30000
				</when>
				<when test="price != null and price == 5">
					and r.price <![CDATA[<=]]> 30000
				</when>
			</choose>-->
		  <if test="minPrice != null and minPrice != ''">
		  	and r.price <![CDATA[>=]]> #{minPrice}
		  </if>
		  <if test="maxPrice != null and maxPrice != ''">
		  	and r.price <![CDATA[<=]]> #{maxPrice}
		  </if>
			<if test="title !='' and title != title ">
				and r.title like CONCAT('%', #{title}, '%')
			</if>
	      <if test="key != '' and key != null ">
	      	and (
	      		r.title like concat('%', #{key}, '%')
	      		or 
	      		r.start_city like concat('%', #{key}, '%')
	      		or 
	      		r.way_city like concat('%', #{key}, '%')
	      		or 
	      		r.travel_date like concat('%', #{key}, '%')
	      		or 
	      		r.cruise_company like concat('%', #{key}, '%')
	      		or 
	      		r.days like concat('%', #{key}, '%')
	      		or 
	      		r.provider_name like concat('%', #{key}, '%')
	      	)
	      </if>
	    </where>
	   order by
	      r.travel_date
  </select>
  <update id="updateResNum" parameterType="com.eyou.trader.resource.domain.Resource">
  	update
  		tb_resource
  	set
  		version_flag = #{versionFlag} + 1,
  		num = num - #{num}
  	where
  		code = #{code} and version_flag = #{versionFlag}
  		and num <![CDATA[>=]]> #{num}
  </update>

	<!-- 根据查询id航次信息 -->
	<select id="searchResourceVersion" resultType="com.eyou.trader.resource.domain.ProductVersion" parameterType="com.eyou.trader.resource.domain.ProductVersion">
		select id, resCode, startDate, endDate,way_city wayCity, title, description, total_num totalNum, num, um_price umPrice, trader_price traderPrice, price, crusie_limit,create_time createTime
		from tb_resource_version
		where 1=1
		<if test="id != '' and id != null ">
			and id = #{id}
		</if>
	</select>

  <!-- 根据邮轮资源id，查询邮轮房型列表 -->
  <select id="searchCruiseHouseList" resultType="java.util.Map">
  	select
  		id, resource_code,cabin_id cabinId,cabin_name,shipping_space_id shippingSpaceId,house_type,cabin_name,house_person_num, house_num, person_num,
  		customer_price price,trader_price traderPrice, version_flag versionFlag
  	from
  		tb_cruise_house
  	where
  		1=1
  		 <choose>
	      <when test="cabinId == 0 ">
	      	and cabin_id = #{cabinId}
	      </when>
	      <when  test="cabinId == 1">
	      	and cabin_id <![CDATA[<>]]> 0
	      </when>
        </choose>
  		<if test="code != '' and code != null ">
	      	and vid = #{code}
	    </if>
		<if test="shippingSpaceId != '' and shippingSpaceId != null ">
	      	and shipping_space_id = #{shippingSpaceId}
	    </if>
  	order by price
  </select>
  <!-- 根据id，查询邮轮房型 -->
  <select id="searchCruiseHouseById" resultType="com.eyou.trader.resource.domain.CruiseHouse">
  	select
  		id, resource_code resourceCode,vid, house_type houseType, house_person_num housePersonNum, house_num houseNum,
  		person_num personNum, um_price umPrice, trader_price traderPrice, customer_price customerPrice, version_flag versionFlag
  	from
  		tb_cruise_house
  	where
  		id = #{id}
  </select>
    <!-- 根据邮轮资源id，查询邮轮房型列表包括联盟价格和直客价格 -->
  <select id="searchCruiseHouseListAllInfo" resultType="java.util.Map" parameterType="com.eyou.trader.resource.domain.ProductVersion">
  	select
  		id, resource_code,vid,cabin_id,cabin_name,shipping_space_id, house_type,cruise_total_num, total_num, house_num, house_person_num,
  		 um_price , customer_price,trader_price,version_flag
  	from
  		tb_cruise_house
  	where 1=1
  		 <choose>
	      <when test="cabinId == 0 ">
	      	and cabin_id = #{cabinId}
	      </when>
	      <when  test="cabinId == 1">
	      	and cabin_id <![CDATA[<>]]> 0
	      </when>
        </choose>
  		<if test="id != '' and id != null ">
	      	and vid = #{id}
	    </if>
		<if test="shippingSpaceId != '' and shippingSpaceId != null ">
	      	and shipping_space_id = #{shippingSpaceId}
	    </if>
  	order by cabin_id,order_num
  </select>
  <!--查找邮轮公司  -->
  <select id="searchCruiseCompList" resultType="java.util.Map">
	select
		id, name
	from
		tb_cruise_company
	order by
		order_num
  </select>

  <!--根据公司id查找邮轮  -->
  <select id="searchCruiseList" resultType="java.util.Map" parameterType="java.lang.String">
  	select
  	id, name
  	from
  	tb_cruise
  	where
  	cruise_company_id=#{cruiseCompId}
  </select>

	<!--根据邮轮id查找邮轮舱型  -->
	<select id="searchCabinList" resultType="java.util.Map" parameterType="java.lang.String">
		select
		id, name
		from
		tb_cabin
		where
		cruise_id=#{cruiseId}
	</select>

	<!--根据邮轮舱型id查找邮轮舱位  -->
	<select id="searchShippingSpaceList" resultType="java.util.Map" parameterType="java.lang.String">
		select
		id, name,house_person_num,cabin_id
		from
		tb_shipping_space
		where
		cabin_id=#{cabinId}
	</select>

	<!--根据邮轮舱位id查找邮轮舱位单间人数  -->
	<select id="searchShippingSpacePersonNum" resultType="java.util.Map" parameterType="java.lang.String">
		select
		house_person_num
		from
		tb_shipping_space
		where
		id=#{shippingSpaceId}
	</select>

  <!--查找出发城市  -->
  <select id="searchCruiseDestList" resultType="java.util.Map">
  	select
		id, name
	from
		tb_cruise_destination
	order by
		order_num
  </select>
  <!--删除船舱  -->
  <delete id="deleteHouseByCode">
  delete from 
  		tb_cruise_house 
  	where resource_code=#{resourceCode}
  </delete>
  <!--删除行程  -->
  <delete id="deleteDescribeByCode" parameterType="com.eyou.trader.resource.domain.ScheDescribe">
  delete from 
  		tb_resource_schedule
  	where 1=1
		<if test="resourceCode != '' and resourceCode != null ">
	      	and resource_code = #{resourceCode}
	    </if>
		<if test="vid != '' and vid != null ">
	      	and vid = #{vid}
	    </if>
  </delete>
  <!--查询审核通过的可用资源  -->
  <select id="searchResourceListToSearchOfIndex" resultType="java.util.Map" parameterType="resource">
  	 select  
  	 code,title,travel_date travelDate,start_city startCity,end_city endCity,board_city_id boardCityId,
    board_city boardCity,way_city_ids wayCityIds,way_city wayCity,days,
    IF( (#{traderLevel} = 0 OR #{traderLevel}=1), um_price , trader_price) price,
    cruise_company_id cruiseCompanyId,cruise_company cruiseCompany,product_type productType,
    team_type teamType,provider_code providerCode,provider_name providerName,
    show_level showLevel,status,word_path wordPath,num
  from tb_resource
  where 1=1
  			and status = 1
  	      <if test="productType != 0 and productType != null ">
	      	and product_type = #{productType}
	      </if>
	      <if test="code != '' and code != null ">
	      	and code = #{code}
	      </if>
	      <if test="title != '' and title != null ">
	      	and title like concat('%', #{title}, '%')
	      </if>
	      <if test="boardCityId != '' and boardCityId != null ">
	      	and board_city_id = #{boardCityId}
	      </if>
	      <if test="wayCity !='' and wayCity != null ">
	      	and way_city like CONCAT('%', #{wayCity}, '%')
	      </if>
	      <if test="cruiseCompanyId != '' and cruiseCompanyId != null ">
	      	and cruise_company_id = #{cruiseCompanyId}
	      </if>
	      <if test="travelDate != '' and travelDate != null ">
	      	and travel_date>= #{travelDate}
	      </if>
	      <if test="deadline != '' and deadline != null ">
	      	and  travel_date &lt;= #{deadline}
	      </if>
	      <if test="providerCode != '' and providerCode != null">
	      and provider_code=#{providerCode}
	      </if>
	      <if test="providerName != '' and providerName != null ">
	      and provider_name like concat('%', #{providerName}, '%')
	      </if>
	      <if test="showLevel != '' and showLevel != null ">
	      and show_Level=#{showLevel}
	      </if>
	      <if test="days != '' and days != null ">
	      and days=#{days}
	      </if>
	      <if test="key != '' and key != null">
	      	and (
	      		title like concat('%', #{key}, '%')
	      		or 
	      		way_city like concat('%', #{key}, '%')
	      		or 
	      		board_city like concat('%', #{key}, '%')
	      		or 
	      		cruise_company like concat('%', #{key}, '%')
	      		or 
	      		provider_name like concat('%', #{key}, '%')
	      	)
	      </if>
  </select>
	<!--统计航次舱位-->
	<select id="checkCruiseHouseIsExit" parameterType="com.eyou.trader.resource.domain.CruiseHouse" resultType="java.lang.Integer">
		select
		count(*)
		from
		tb_cruise_house
		where 1=1
		<if test="vid != '' and vid != null ">
			and vid = #{vid}
		</if>
		<if test="shippingSpaceId != '' and shippingSpaceId != null ">
			and shipping_space_id = #{shippingSpaceId}
		</if>
	</select>

  <select id="searchAllCruise" resultType="java.util.Map">
	     select 
	         code,title
	     from
	         tb_resource
	     where 
	         product_type=21 AND status=1 and show_level=1      
  </select>
  <select id="searchAllCruiseWS" resultType="com.eyou.trader.resource.domain.Resource">
 	select
 		code, title, travel_date travelDate, start_city startCity, trader_price traderPrice
  	from 
  		tb_resource
  	where
  		travel_date >= DATE_FORMAT(NOW(),'%Y-%m-%d')
  </select>
  <select id="selectCruiseByCurrentTraderCode" resultType="java.util.Map" parameterType="resource">
   SELECT r.code,r.title FROM tb_resource r 
   WHERE r.provider_code=#{currentTraderCode} and r.product_type=21 
  </select>
	<!--统计资源信息-->
	<select id="statisticsResource" resultType="java.util.Map">
		SELECT * from (SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '100%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '101%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '102%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '103%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '104%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '105%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '106%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '107%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '108%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '109%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '110%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '111%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '112%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '113%'
		UNION SELECT COUNT(*) COUNT,board_city_id FROM tb_resource WHERE board_city_id LIKE '114%')tb_count
		where board_city_id is not null
	</select>
	<!--华美欧每周推荐-->
	<select id="weekRecommend" parameterType="com.eyou.trader.resource.domain.Resource" resultType="java.util.Map">
		SELECT c.id id,c.title title,startDate,endDate,c.minPrice,r.code ,r.cruise_id cruiseId,r.product_type productType,r.pic_path picPath
		FROM tb_resource r
		 RIGHT JOIN (SELECT
		  a.id,title,resCode,startDate,endDate,
		  MIN(b.customer_price) AS minPrice
		FROM
		  tb_resource_version a
		  LEFT JOIN
		  tb_cruise_house b
		  ON a.id = b.vid
		WHERE 1 = 1
		  AND startDate >= DATE_FORMAT(NOW(), '%Y-%m-%d h:m:s')
		  GROUP BY b.resource_code) c
		  ON r.code = c. resCode
		  ORDER BY startDate ASC

	</select>

	<select id="getMinHousePriceByVid" parameterType="com.eyou.trader.resource.domain.ProductVersion" resultType="java.lang.Double">
		SELECT MIN(customer_price) FROM tb_cruise_house
		WHERE 1=1
		<if test="id != '' and id != null ">
		 and vid = #{id}
		</if>
       <choose>
	      <when test="cabinId == 0 ">
	      	and cabin_id = #{cabinId}
	      </when>
	      <when  test="cabinId == 1">
	      	and cabin_id <![CDATA[<>]]> 0
	      </when>
        </choose>
	</select>
	<select id="getTraderMinHousePriceByVid" parameterType="com.eyou.trader.resource.domain.ProductVersion" resultType="java.lang.Double">
		SELECT MIN(trader_price) FROM tb_cruise_house
		WHERE 1=1
		<if test="id != '' and id != null ">
		 and vid = #{id}
		</if>
       <choose>
	      <when test="cabinId == 0 ">
	      	and cabin_id = #{cabinId}
	      </when>
	      <when  test="cabinId == 1">
	      	and cabin_id <![CDATA[<>]]> 0
	      </when>
        </choose>
	</select>

	<select id="getHotDestination" parameterType="com.eyou.trader.resource.domain.Destination" resultType="java.util.Map">
		select id, pid, name, order_num, is_enable
		from tb_cruise_destination
		where 1=1
		<if test="pid != '' and pid != null ">
			and pid like concat( #{pid}, '%')
		</if>
	</select>
	<!-- 班期id获取所有舱型 -->
	<select id="searcHourseByVersion" parameterType="com.eyou.trader.resource.domain.Resource" resultType="java.util.Map">
<!-- 		SELECT ch.`house_type`,ch.`house_person_num`,ch.`house_num`,ch.um_price,ch.`trader_price`,ch.`customer_price` -->
		SELECT ch.*
			FROM tb_cruise_house ch 
			WHERE vid=#{code}
			GROUP BY house_type ;
	</select>
	<!-- 查询产品发布人的信息 -->
	<select id="searchPublishMan" parameterType="com.eyou.trader.resource.domain.Resource" resultType="com.eyou.trader.user.domain.User">
		SELECT us.email email
			FROM tb_user us 
			LEFT JOIN tb_resource rs
			ON us.id=rs.publisher_id
		WHERE rs.code=#{code}
	</select>
</mapper>